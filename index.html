<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tima</title>
    <link rel="icon" href="assets/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="assets/website.manifest">
    <link rel="stylesheet" href="assets/style.css">
</head>

<body>
    <div class="progress-circle" id="progress-circle">
        <svg viewBox="0 0 400 400">
            <circle fill="none" stroke="#444" stroke-width="13" cx="200" cy="200" r="185.5" />
            <circle fill="none" stroke="#999" stroke-width="13" cx="200" cy="200" r="185.5" stroke-linecap="round"
                transform="rotate(-90 200 200)" id="progress" />
        </svg>
        <div class="text" id="progress-text">60</div>
    </div>

    <div class="elapsed-time" id="elapsed-time">00:00</div>
    <div class="settings-button" id="settings-button">â€¦</div>
    <div class="settings-dialog" id="settings-dialog">
        <span class="close-button" id="close-button">&times;</span>
        <p>Einstellungen</p>
        <label for="beep-times">Beep Zeiten (Sekunden, durch Kommas getrennt):</label>
        <input type="text" id="beep-times" value="45,30,15,3,2,1,0">
        <label for="timer-duration">Dauer des Countdown-Timers (Sekunden):</label>
        <input type="number" id="timer-duration" value="60">
    </div>
    
    <script>
        const progresscircle = document.getElementById('progress-circle');
        const progressText = document.getElementById('progress-text');
        const progressPath = document.getElementById('progress');
        const elapsedTimeDisplay = document.getElementById('elapsed-time');
        const settingsButton = document.getElementById('settings-button');
        const settingsDialog = document.getElementById('settings-dialog');
        const closeButton = document.getElementById('close-button');
        const beepTimesInput = document.getElementById('beep-times');
        const timerDurationInput = document.getElementById('timer-duration');
        const beep = new Audio('assets/blip-131856.mp3');
        let beepTimes = [45, 30, 15, 3, 2, 1, 0];
        let timerDuration = 60;
        let timeLeft = timerDuration * 10;
        let elapsedTime = 0;
        let countdown;
        let running = false;

        function setCookie(name, value, days) {			
            if (window.localStorage) {
                window.localStorage.setItem(name, value);
            } else {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + d.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }
        }

        function getCookie(name) {			
            if (window.localStorage) {
				const value = window.localStorage.getItem(name);
				console.log('Item erfolgreich abgerufen:', name, value);
				return value;
			} else {
                const cname = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const ca = decodedCookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(cname) === 0) {
                        return c.substring(cname.length, c.length);
                    }
                }
                return "";
            }
        }

        function loadSettings() {
            const beepTimesCookie = getCookie("beepTimes");
            if (beepTimesCookie) {
                beepTimes = beepTimesCookie.split(',').map(Number);
                beepTimesInput.value = beepTimesCookie;
            }
            const timerDurationCookie = getCookie("timerDuration");
            if (timerDurationCookie) {
                timerDuration = Number(timerDurationCookie);
                timerDurationInput.value = timerDuration;
                timeLeft = timerDuration * 10;
                progressText.innerText = timerDuration;
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        settingsButton.addEventListener('click', () => {
            settingsDialog.style.display = settingsDialog.style.display === 'block' ? 'none' : 'block';
        });

        closeButton.addEventListener('click', () => {
            settingsDialog.style.display = 'none';
        });

        beepTimesInput.addEventListener('change', () => {
            beepTimes = beepTimesInput.value.split(',').map(Number);
            setCookie("beepTimes", beepTimesInput.value, 365);
        });

        timerDurationInput.addEventListener('change', () => {
            timerDuration = Number(timerDurationInput.value);
            setCookie("timerDuration", timerDuration, 365);
            timeLeft = timerDuration * 10;
            progressText.innerText = timerDuration;
        });

        progresscircle.addEventListener('click', () => {
            if (!running) {
                running = true;
                countdown = setInterval(() => {
                    timeLeft--;
                    elapsedTime++;
                    timeLeft_in_seconds = Math.floor(timeLeft / 10);
                    progressPath.style.strokeDashoffset = (timeLeft / (timerDuration * 10)) * 1165;
                    progressPath.style.transition = timeLeft > (timerDuration * 10 - 2) ? 'none' : 'stroke-dashoffset 0.1s linear';
                    if (timeLeft % 10 == 0) {
                        progressText.innerText = timeLeft == 0 ? timerDuration : timeLeft_in_seconds;
                        elapsedTimeDisplay.innerText = formatTime(Math.floor(elapsedTime / 10));
                        if (beepTimes.includes(timeLeft_in_seconds)) {
                            beep.play();
                        }
                    }
                    if (timeLeft <= 0) {
                        timeLeft = timerDuration * 10;
                    }
                }, 100);
            } else {
                clearInterval(countdown);
                running = false;
            }
        });

        loadSettings();
    </script>
</body>

</html>